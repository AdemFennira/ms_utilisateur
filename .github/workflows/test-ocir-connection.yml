name: Test OCIR Connection

on:
  workflow_dispatch:
    inputs:
      test-pull:
        description: 'Test pulling an existing image'
        required: false
        type: boolean
        default: false

jobs:
  test-connection:
    name: Test OCIR Connection
    runs-on: ubuntu-latest
    environment: BACKEND_ENVIRONMENT

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Debug - Display Secrets Info
        run: |
          echo "================================================"
          echo "  VÉRIFICATION DES SECRETS"
          echo "================================================"
          echo ""
          
          # Vérifier OCI_TENANCY_NAMESPACE
          if [ -z "${{ secrets.OCI_TENANCY_NAMESPACE }}" ]; then
            echo "❌ OCI_TENANCY_NAMESPACE est VIDE ou non défini"
          else
            echo "✅ OCI_TENANCY_NAMESPACE est défini"
            echo "   Valeur: ${{ secrets.OCI_TENANCY_NAMESPACE }}"
          fi
          echo ""
          
          # Vérifier OCI_USERNAME
          if [ -z "${{ secrets.OCI_USERNAME }}" ]; then
            echo "❌ OCI_USERNAME est VIDE ou non défini"
          else
            echo "✅ OCI_USERNAME est défini"
            USERNAME="${{ secrets.OCI_USERNAME }}"
            echo "   Longueur: ${#USERNAME} caractères"
            echo "   Premiers caractères: ${USERNAME:0:3}***"
            
            # Vérifier si c'est un email
            if [[ "$USERNAME" == *"@"* ]]; then
              echo "   ⚠️  ATTENTION: Le username ressemble à un email!"
              echo "   ⚠️  Cela va probablement échouer"
              echo "   ⚠️  Utilisez votre nom d'utilisateur OCI, pas votre email"
            else
              echo "   ✅ Le username ne semble pas être un email"
            fi
            
            # Vérifier le format avec namespace
            if [[ "$USERNAME" == *"/"* ]]; then
              echo "   ✅ Le username contient déjà le namespace"
            else
              echo "   ℹ️  Le username sera préfixé avec le namespace"
            fi
          fi
          echo ""
          
          # Vérifier OCI_AUTH_TOKEN
          if [ -z "${{ secrets.OCI_AUTH_TOKEN }}" ]; then
            echo "❌ OCI_AUTH_TOKEN est VIDE ou non défini"
          else
            TOKEN="${{ secrets.OCI_AUTH_TOKEN }}"
            echo "✅ OCI_AUTH_TOKEN est défini"
            echo "   Longueur: ${#TOKEN} caractères"
            echo "   Premiers caractères: ${TOKEN:0:3}***"
          fi
          echo ""

      - name: Test OCIR Login
        run: |
          echo "================================================"
          echo "  TEST DE CONNEXION À OCIR"
          echo "================================================"
          echo ""
          
          REGISTRY="cdg.ocir.io"
          NAMESPACE="${{ secrets.OCI_TENANCY_NAMESPACE }}"
          USERNAME="${{ secrets.OCI_USERNAME }}"
          TOKEN="${{ secrets.OCI_AUTH_TOKEN }}"
          
          # Vérifier que les variables sont définies
          if [ -z "$NAMESPACE" ] || [ -z "$USERNAME" ] || [ -z "$TOKEN" ]; then
            echo "❌ Un ou plusieurs secrets sont manquants"
            echo "   NAMESPACE: $([ -z "$NAMESPACE" ] && echo 'VIDE' || echo 'OK')"
            echo "   USERNAME: $([ -z "$USERNAME" ] && echo 'VIDE' || echo 'OK')"
            echo "   TOKEN: $([ -z "$TOKEN" ] && echo 'VIDE' || echo 'OK')"
            exit 1
          fi
          
          # Formater le username
          if [[ "$USERNAME" != *"/"* ]]; then
            FULL_USERNAME="${NAMESPACE}/${USERNAME}"
            echo "ℹ️  Username formaté: ${NAMESPACE}/<username>"
          else
            FULL_USERNAME="$USERNAME"
            echo "✅ Username au format complet"
          fi
          
          echo ""
          echo "Configuration de connexion:"
          echo "  Registry: $REGISTRY"
          echo "  Namespace: $NAMESPACE"
          echo "  Username (partiel): ${FULL_USERNAME%%/*}/***"
          echo ""
          
          # Test de connexion
          echo "Tentative de connexion..."
          if echo "$TOKEN" | docker login "$REGISTRY" -u "$FULL_USERNAME" --password-stdin 2>&1; then
            echo ""
            echo "================================================"
            echo "  ✅ CONNEXION RÉUSSIE !"
            echo "================================================"
            echo ""
            echo "Les credentials sont corrects !"
            echo "Le workflow principal devrait fonctionner maintenant."
          else
            echo ""
            echo "================================================"
            echo "  ❌ ÉCHEC DE CONNEXION"
            echo "================================================"
            echo ""
            echo "Vérifications à faire :"
            echo ""
            echo "1️⃣  Vérifier OCI_USERNAME"
            echo "   ⚠️  NE PAS utiliser votre email !"
            echo "   ✅ Utilisez votre nom d'utilisateur OCI"
            echo ""
            echo "   Pour le trouver, dans OCI Cloud Shell :"
            echo "   oci iam user list --all | jq -r '.data[] | select(.email==\"abdelmoughitboutchi4@gmail.com\") | .name'"
            echo ""
            echo "2️⃣  Vérifier OCI_TENANCY_NAMESPACE"
            echo "   Valeur actuelle: $NAMESPACE"
            echo "   Attendu: axfuowvuxal7 (avec 'f', pas 't')"
            echo ""
            echo "   Pour vérifier, dans OCI Cloud Shell :"
            echo "   oci os ns get"
            echo ""
            echo "3️⃣  Vérifier OCI_AUTH_TOKEN"
            echo "   Assurez-vous qu'il est actif dans:"
            echo "   Console OCI > User Settings > Auth Tokens"
            echo ""
            echo "4️⃣  Vérifier les permissions IAM"
            echo "   Console OCI > Identity > Policies"
            echo "   Policy requise: Allow group <votre-groupe> to manage repos in tenancy"
            echo ""
            exit 1
          fi

      - name: Test Listing Repositories (Optional)
        if: success()
        continue-on-error: true
        run: |
          echo "================================================"
          echo "  TEST DE LISTING DES REPOSITORIES"
          echo "================================================"
          echo ""
          
          # Essayer de chercher des images (peut ne pas fonctionner selon les permissions)
          echo "Recherche d'images dans le namespace..."
          docker search cdg.ocir.io/${{ secrets.OCI_TENANCY_NAMESPACE }}/smartdish 2>&1 || {
            echo ""
            echo "ℹ️  La recherche d'images n'est pas supportée ou accessible"
            echo "   Ce n'est pas un problème - la connexion a réussi !"
          }

      - name: Test Pulling Image (Optional)
        if: ${{ inputs.test-pull && success() }}
        continue-on-error: true
        run: |
          echo "================================================"
          echo "  TEST DE PULL D'UNE IMAGE"
          echo "================================================"
          echo ""
          
          IMAGE="cdg.ocir.io/${{ secrets.OCI_TENANCY_NAMESPACE }}/smartdish/univ-soa:latest"
          echo "Tentative de pull de: $IMAGE"
          echo ""
          
          if docker pull "$IMAGE" 2>&1; then
            echo ""
            echo "✅ Pull d'image réussi !"
            docker images | grep smartdish
          else
            echo ""
            echo "ℹ️  Impossible de pull l'image"
            echo "   Causes possibles:"
            echo "   - L'image n'existe pas encore"
            echo "   - Le tag 'latest' n'existe pas"
            echo "   - Permissions insuffisantes"
            echo ""
            echo "   Ce n'est pas grave si la connexion a réussi !"
          fi

      - name: Summary
        if: always()
        run: |
          echo "================================================"
          echo "  RÉSUMÉ DU TEST"
          echo "================================================"
          echo ""
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Test réussi !"
            echo ""
            echo "Vos credentials OCIR sont corrects."
            echo "Le workflow de déploiement devrait fonctionner."
            echo ""
            echo "Prochaines étapes:"
            echo "1. Commitez et pushez vos changements"
            echo "2. Le workflow principal devrait se déclencher"
            echo "3. Surveillez les logs pour confirmation"
          else
            echo "❌ Test échoué"
            echo ""
            echo "Consultez les logs ci-dessus pour identifier le problème."
            echo ""
            echo "Documentation disponible:"
            echo "- FIX_SECRETS_GITHUB.md"
            echo "- GUIDE_RESOLUTION_DEPLOIEMENT.md"
            echo "- DEBUGGING_GUIDE.md"
          fi
